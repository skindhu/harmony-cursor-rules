作为一位资深的HarmonyOS界面开发专家，我将基于您提供的华为官方文档HTML内容，为您分析并整理出“文本展开折叠”功能的界面开发最佳实践。

# 文本展开折叠 - 最佳实践

## 📋 概述
“文本展开折叠”功能主要应用于列表中的博文、评论等复合型内容组件，当文本内容超出预设的行数阈值时，自动收起并显示“展开”按钮，点击后显示全部内容并切换为“收起”按钮。其核心挑战在于精确判断文本截断位置，尤其是在包含图片表情等非固定大小元素时，如何准确计算文本结尾和按钮位置。本文档旨在提供一种基于系统模块的简洁解决方案。

## 🎯 最佳实践

### 1. 纯文本展开折叠处理
- **实践要点**：
    *   当纯文本内容超过指定行数（例如3行）时，自动截断并显示“...展开”提示。
    *   点击“展开”后显示全部文本，并提供“收起”选项。
    *   确保“展开/收起”按钮与文本内容无缝衔接。
- **实现方式**：
    *   **文本高度测量**：利用HarmonyOS提供的 `measureTextSize()` 方法精确测量原始文本的实际高度、宽度和行高。这是确定文本是否需要折叠以及折叠位置的基础。
    *   **截断点计算**：根据预设的最大显示行数和单行行高，计算出收起状态下文本的预期高度。结合“...”和“展开”按钮的宽度，反推出在达到该高度前最后一个文字的索引和坐标。
    *   **内容动态切换**：
        *   如果测量出的文本实际高度小于或等于预设的限制行数高度（例如 `lineHeight * 2`，对应3行文本），则无需处理，直接显示全部文本。
        *   如果文本超出限制，则通过计算得到的索引截断文本，并显示“...展开”按钮。
        *   通过状态变量（如 `expanded`）控制显示截断内容还是全部内容，并动态切换“展开”和“收起”按钮的文本。
- **注意事项**：
    *   精确计算“...”前最后一个文字的索引至关重要，这决定了文本截断的准确性和视觉效果。
    *   要考虑按钮和“...”的宽度，确保它们不会遮挡有效文本内容，并且整体布局协调。
    *   `measureTextSize()` 方法需要传入 `textContent`、`lineHeight`、`constraintWidth` (文本布局宽度) 和 `fontSize` 等参数，确保测量结果的准确性。

### 2. 富文本展开折叠（文档提及，但细节待补充）
- **实践要点**：
    *   文档提到了富文本展开折叠的场景，这通常涉及文本与图片、表情等混合内容。
    *   挑战在于图片等非文字元素的大小和位置不固定，使得文本截断和按钮定位更加复杂。
- **实现方式**：
    *   （**文档中此部分实现原理和开发步骤内容不完整，无法提取具体细节。**）
    *   根据概述部分的提示，可能需要更复杂的布局测量和内容渲染逻辑来处理图片等元素对文本布局的影响。
- **注意事项**：
    *   处理富文本时，需要额外考虑图片、表情等内联元素对文本流和行高的影响，可能需要自定义布局或更精细的测量逻辑，以避免截断不当或按钮位置错误。

## 💡 代码示例

以下是文档中提供的一个计算文本是否需要展开/折叠的示例代码片段，展示了如何使用 `measureTextSize()` 来判断文本高度：

```arkts
// 假设 this.textSectionAttribute 包含了文本内容、行高、约束宽度和字体大小等属性
getIsExpanded() {
  let titleSize: SizeOptions = this.uiContext.getMeasureUtils().measureTextSize({
    textContent: this.textSectionAttribute.title, // 待计算的文本内容
    lineHeight: this.textSectionAttribute.lineHeight,
    constraintWidth: this.textSectionAttribute.constraintWidth, // 文本布局宽度
    fontSize: this.textSectionAttribute.fontSize // 文本字体大小
  });

  // 将像素高度转换为vp单位
  let height = this.getUIContext().px2vp(Number(titleSize.height));

  // 判断文本高度是否小于等于预设的行数限制（例如，这里是2行的高度）
  if (height <= this.textSectionAttribute.lineHeight * 2) {
    this.textModifier.needProcess = false; // 不需要展开折叠处理
    this.textModifier.title = this.textSectionAttribute.title; // 显示全部内容
    return;
  } else {
    this.textModifier.needProcess = true; // 需要展开折叠处理
  }

  // 后续逻辑会根据 this.expanded 状态来决定显示截断内容还是全部内容
  if (this.expanded) {
    // ... 展开状态的逻辑
  } // ... 代码片段在此处被截断
}
```

## ⚠️ 常见陷阱

### 避免的做法
- **硬编码文本截断长度**：不根据实际文本内容和字体大小进行测量，而是简单地通过字符数量进行截断，会导致在不同设备、字体大小或语言环境下显示效果不佳，可能出现截断在单词中间、标点符号后等不自然的情况。
- **忽略布局约束**：不考虑文本所在组件的实际布局宽度（`constraintWidth`），导致 `measureTextSize()` 测量结果不准确，进而影响折叠判断和截断位置。
- **未处理“...”和按钮的宽度**：在计算截断位置时，如果未预留“...”和“展开/收起”按钮的空间，可能会导致它们覆盖部分有效文本，影响用户阅读体验。
- **富文本处理简单化**：在富文本场景中，直接套用纯文本的测量和截断逻辑，不考虑图片、表情等内联元素对文本流的实际影响，可能导致排版错乱。

### 推荐的做法
- **始终使用 `measureTextSize()` API**：这是HarmonyOS官方推荐的文本测量方法，能够精确获取文本在给定约束下的尺寸，是实现动态文本展开折叠的基础。
- **精确计算截断索引**：结合 `measureTextSize()` 的结果，以及“...”和按钮的宽度，通过迭代或二分查找等方式，精确计算出在达到最大显示行高时最后一个可见字符的索引。
- **状态管理清晰**：使用响应式数据（如 `@State` 装饰器修饰的变量）来管理文本的展开/收起状态，确保UI能够根据状态变化及时更新。
- **提供清晰的视觉指示**：确保“展开/收起”按钮的位置醒目且可点击，并有明确的文本提示，引导用户操作。

## 🔗 相关资源
- 原文档：https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-text-expand-collapse